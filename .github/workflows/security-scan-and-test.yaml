name: Security Scan and Performance Testing

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  schedule:
    # Run security scans daily at 3 AM UTC
    - cron: '0 3 * * *'

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, gd, xml, zip

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: WordPress Security Scanner (WPScan)
        uses: wpscanteam/wpscan-action@v1
        with:
          url: 'https://lesterbarahona.com'
          token: ${{ secrets.WPSCAN_API_TOKEN }}
          
      - name: PHP Security Scanner
        run: |
          # Install PHP security scanner
          wget -O security-checker https://get.sensiolabs.org/security-checker.phar
          chmod +x security-checker
          ./security-checker security:check composer.lock

      - name: Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, gd, xml, zip
          tools: phpstan, psalm

      - name: Install Composer dependencies
        run: composer install --dev

      - name: Run PHPStan
        run: |
          # Create PHPStan config if not exists
          if [ ! -f phpstan.neon ]; then
            cat > phpstan.neon << 'EOF'
          parameters:
            level: 5
            paths:
              - mu-plugins
              - themes
            excludePaths:
              - themes/*/vendor/*
          EOF
          fi
          phpstan analyse --no-progress --error-format=github

      - name: WordPress Coding Standards
        run: |
          # Install WordPress Coding Standards
          composer global require wp-coding-standards/wpcs
          phpcs --config-set installed_paths ~/.composer/vendor/wp-coding-standards/wpcs
          
          # Run coding standards check
          phpcs --standard=WordPress --extensions=php mu-plugins/ themes/ || true

  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Load Testing with k6
        uses: grafana/k6-action@v0.3.1
        with:
          filename: ci-scripts/load-test.js
        env:
          TARGET_URL: https://lesterbarahona.com

  docker-security:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t lbarahona-blog:test .

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'lbarahona-blog:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: Docker Bench Security
        run: |
          docker run --rm --net host --pid host --userns host --cap-add audit_control \
            -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
            -v /var/lib:/var/lib:ro \
            -v /var/run/docker.sock:/var/run/docker.sock:ro \
            -v /usr/lib/systemd:/usr/lib/systemd:ro \
            -v /etc:/etc:ro \
            --label docker_bench_security \
            docker/docker-bench-security || true

  infrastructure-security:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Terraform Security Scanner (tfsec)
        uses: aquasecurity/tfsec-action@v1.0.0
        if: hashFiles('**/*.tf') != ''
        with:
          soft_fail: true

      - name: Kubernetes Security Scanner (kubesec)
        run: |
          # Install kubesec
          wget https://github.com/controlplaneio/kubesec/releases/latest/download/kubesec_linux_amd64.tar.gz
          tar -xzf kubesec_linux_amd64.tar.gz
          chmod +x kubesec
          
          # Scan Kubernetes manifests
          find . -name "*.yaml" -o -name "*.yml" | grep -E "(kube|k8s)" | while read file; do
            echo "Scanning $file"
            ./kubesec scan "$file" || true
          done

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

      - name: GitLeaks Secrets Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  compliance-check:
    name: Compliance and Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security headers in PHP files
        run: |
          echo "Checking for security headers implementation..."
          
          # Check if security headers are properly implemented
          if grep -r "X-Frame-Options\|X-XSS-Protection\|X-Content-Type-Options" mu-plugins/ themes/; then
            echo "✅ Security headers found in code"
          else
            echo "❌ Security headers not implemented"
            exit 1
          fi

      - name: Check for HTTPS enforcement
        run: |
          echo "Checking for HTTPS enforcement..."
          
          if grep -r "FORCE_SSL\|https" .; then
            echo "✅ HTTPS enforcement found"
          else
            echo "⚠️ HTTPS enforcement should be implemented"
          fi

      - name: Check for database security measures
        run: |
          echo "Checking for database security measures..."
          
          # Check for SQL injection protection
          if grep -r "sanitize\|wp_kses\|prepare" mu-plugins/ themes/; then
            echo "✅ Input sanitization found"
          else
            echo "❌ Input sanitization not found"
            exit 1
          fi

      - name: Check for file upload security
        run: |
          echo "Checking for file upload security..."
          
          if grep -r "upload_mimes\|wp_handle_upload" mu-plugins/ themes/; then
            echo "✅ File upload security measures found"
          else
            echo "⚠️ File upload security should be implemented"
          fi

  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Install Composer dependencies
        run: composer install

      - name: Check for known vulnerabilities in dependencies
        run: |
          # Install security checker
          wget -O security-checker https://get.sensiolabs.org/security-checker.phar
          chmod +x security-checker
          
          # Check for vulnerabilities
          ./security-checker security:check composer.lock --format=json > security-report.json || true
          
          # Display results
          if [ -s security-report.json ]; then
            echo "Security vulnerabilities found:"
            cat security-report.json
          else
            echo "No known vulnerabilities found in dependencies"
          fi

      - name: Upload security report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-report
          path: security-report.json

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-scan, static-analysis, docker-security, secrets-scan, dependency-check]
    if: always()
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        continue-on-error: true

      - name: Generate Security Summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Date:** $(date)" >> security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Scan Results" >> security-summary.md
          echo "- **Security Scan:** ${{ needs.security-scan.result }}" >> security-summary.md
          echo "- **Static Analysis:** ${{ needs.static-analysis.result }}" >> security-summary.md
          echo "- **Docker Security:** ${{ needs.docker-security.result }}" >> security-summary.md
          echo "- **Secrets Detection:** ${{ needs.secrets-scan.result }}" >> security-summary.md
          echo "- **Dependency Check:** ${{ needs.dependency-check.result }}" >> security-summary.md
          echo "" >> security-summary.md
          
          if [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.secrets-scan.result }}" != "success" ] || \
             [ "${{ needs.dependency-check.result }}" != "success" ]; then
            echo "⚠️ **Security issues detected. Please review the scan results.**" >> security-summary.md
          else
            echo "✅ **All security scans passed.**" >> security-summary.md
          fi

      - name: Comment Security Summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Upload Security Summary
        uses: actions/upload-artifact@v3
        with:
          name: security-summary
          path: security-summary.md